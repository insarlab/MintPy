jobs:
  build:
    docker:
      - image: ubuntu:bionic
        user: root

    steps:
      - run:
          name: Setting Environment Variables
          command: |
            apt-get update
            apt-get upgrade -y
            apt-get install -y git
            apt-get install -y wget
            # if [ -z ${PYTHONPATH+x} ]; then export PYTHONPATH=""; fi
            export MINTPY_HOME=~/tools/MintPy
            export PYAPS_HOME=~/tools/PyAPS
            export CONDA_PREFIX=~/tools/miniconda3
            export PYTHONPATH=${PYTHONPATH}:${MINTPY_HOME}:${PYAPS_HOME}
            export PATH=${PATH}:${CONDA_PREFIX}/bin:${MINTPY_HOME}/mintpy
            echo $MINTPY_HOME

      - run:
          name: Downloading MintPy and PyAPS
          command: | 
            export MINTPY_HOME=~/tools/MintPy
            export PYAPS_HOME=~/tools/PyAPS
            git clone https://github.com/insarlab/MintPy.git $MINTPY_HOME
            git clone https://github.com/yunjunz/pyaps3.git $PYAPS_HOME/pyaps3
            pwd
            ls

      - run:
          name: Installing Dependencies via Conda
          command: |
            pwd
            ls
            export MINTPY_HOME=~/tools/MintPy
            export CONDA_PREFIX=~/tools/miniconda3
            export PATH=${PATH}:${CONDA_PREFIX}/bin:${MINTPY_HOME}/mintpy
            wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
            chmod +x Miniconda3-latest-Linux-x86_64.sh
            ./Miniconda3-latest-Linux-x86_64.sh -b -p ${CONDA_PREFIX}
            ${CONDA_PREFIX}/bin/conda config --add channels conda-forge
            ${CONDA_PREFIX}/bin/conda install --yes --file $MINTPY_HOME/docs/conda.txt
            ${CONDA_PREFIX}/bin/pip install git+https://github.com/tylere/pykml.git

      - run:
          name: Testing MintPy on Example Datasets
          command: |
            export MINTPY_HOME=~/tools/MintPy
            export PYAPS_HOME=~/tools/PyAPS
            export CONDA_PREFIX=~/tools/miniconda3
            export PYTHONPATH=${PYTHONPATH}:${MINTPY_HOME}:${PYAPS_HOME}
            export PATH=${PATH}:${CONDA_PREFIX}/bin:${MINTPY_HOME}/mintpy
            mkdir -p /root/data
            cd /root/data
            ${MINTPY_HOME}/test/test_smallbaselineApp.py --dir /root/data --dset all

workflows:
  version: 2
  build_and_test:
    jobs:
      - build

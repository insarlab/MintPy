jobs:
  build:
    docker:
      - image: ubuntu:bionic
        user: root
    steps:
      - run:
          name: Setting Environment Variables
          command: |
            apt-get update
            apt-get upgrade -y
            apt-get install -y git
            apt-get install -y wget
            # if [ -z ${PYTHONPATH+x} ]; then export PYTHONPATH=""; fi
            echo $MINTPY_HOME
            export MINTPY_HOME=~/tools/MintPy
            export PYTHONPATH=${PYTHONPATH}:${MINTPY_HOME}
            export PATH=${PATH}:${MINTPY_HOME}/mintpy
            export PYAPS_HOME=~/tools/PyAPS
            export PYTHONPATH=${PYTHONPATH}:${PYAPS_HOME}
      - run:
          name: Downloading MintPy and PyAPS
          command: | 
            export MINTPY_HOME=~/tools/MintPy
            export PYAPS_HOME=~/tools/PyAPS
            git clone https://github.com/insarlab/MintPy.git $MINTPY_HOME
            git clone https://github.com/yunjunz/pyaps3.git $PYAPS_HOME/pyaps3
            pwd
            ls
      - run:
          name: Installing Dependencies via Conda
          command: |
            pwd
            ls
            export MINTPY_HOME=~/tools/MintPy
            export PYTHONPATH=${PYTHONPATH}:${MINTPY_HOME}
            export PATH=${PATH}:${MINTPY_HOME}/mintpy
            export PYTHON3DIR=~/tools/miniconda3
            export PATH=${PATH}:${PYTHON3DIR}/bin
            export PYAPS_HOME=~/tools/PyAPS
            export PYTHONPATH=${PYTHONPATH}:${PYAPS_HOME}
            wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
            chmod +x Miniconda3-latest-Linux-x86_64.sh
            ./Miniconda3-latest-Linux-x86_64.sh -b -p $PYTHON3DIR
            $PYTHON3DIR/bin/conda config --add channels conda-forge
            $PYTHON3DIR/bin/conda install --yes --file $MINTPY_HOME/docs/conda.txt
            $PYTHON3DIR/bin/pip install git+https://github.com/tylere/pykml.git
      - run:
          name: Testing Mintpy on Fernandina
          command: |
            export MINTPY_HOME=~/tools/MintPy
            export PYTHONPATH=${PYTHONPATH}:${MINTPY_HOME}
            export PATH=${PATH}:${MINTPY_HOME}/mintpy
            export PYTHON3DIR=~/tools/miniconda3
            export PATH=${PATH}:${PYTHON3DIR}/bin
            export PYAPS_HOME=~/tools/PyAPS
            export PYTHONPATH=${PYTHONPATH}:${PYAPS_HOME}
            wget https://zenodo.org/record/3635245/files/FernandinaSenDT128.tar.xz
            tar -xvJf FernandinaSenDT128.tar.xz
            cd FernandinaSenDT128/mintpy
            smallbaselineApp.py ${MINTPY_HOME}/test/configs/FernandinaSenDT128.txt 
      
workflows:
  version: 2
  build_and_test:
    jobs:
      - build